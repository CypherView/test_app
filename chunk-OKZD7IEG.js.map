{
  "version": 3,
  "sources": ["src/app/core/services/version-update.service.ts"],
  "sourcesContent": ["import { Injectable, inject } from '@angular/core';\nimport { ToastService } from './toast.service';\nimport { isDefined } from '../../shared/utils';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class VersionUpdateService {\n  private readonly toastService = inject(ToastService);\n  private hasShownUpdatePrompt = false;\n\n  /**\n   * Detects if an error is related to version mismatch/chunk loading\n   */\n  isVersionMismatchError(error: unknown): boolean {\n    const errorObj = this.normalizeError(error);\n\n    const versionPatterns = [\n      /Loading chunk \\d+ failed/i,\n      /Failed to fetch dynamically imported module/i,\n      /ChunkLoadError/i,\n      /Cannot find module/i,\n      /Failed to load resource/i,\n      /Module not found/i,\n    ];\n\n    const message = errorObj.message || '';\n    const name = errorObj.name || '';\n\n    return versionPatterns.some(\n      (pattern) => pattern.test(message) || pattern.test(name),\n    );\n  }\n\n  /**\n   * Triggers the version update flow with user notification\n   */\n  handleVersionMismatch(errorContext?: string): void {\n    if (this.hasShownUpdatePrompt) {\n      console.warn('Version update already triggered');\n      return;\n    }\n\n    this.hasShownUpdatePrompt = true;\n\n    const message = isDefined(errorContext)\n      ? `A new version is available (${errorContext}). The page will reload to get the latest version.`\n      : 'A new version is available. The page will reload to get the latest version.';\n\n    this.toastService.showWarning('Update Available', message, { life: 5000 });\n\n    // Reload after toast displays - increased delay for zoneless environment\n    setTimeout(() => {\n      this.performHardReload();\n    }, 2500);\n  }\n\n  /**\n   * Performs a hard reload with cache bust and Service Worker cleanup\n   */\n  private performHardReload(): void {\n    try {\n      // Clear Service Worker cache before reload\n      if ('serviceWorker' in navigator) {\n        navigator.serviceWorker\n          .getRegistrations()\n          .then((registrations) => {\n            registrations.forEach((reg) => {\n              reg\n                .unregister()\n                .then(() => {\n                  console.log('Service Worker unregistered');\n                })\n                .catch(() => {});\n            });\n          })\n          .catch((error) =>\n            console.warn('Failed to unregister Service Workers:', error),\n          );\n      }\n\n      // Add timestamp to force cache bust\n      const currentUrl = new URL(globalThis.location.href);\n      currentUrl.searchParams.set('_v', Date.now().toString());\n\n      // Hard reload - replace entire URL to bypass cache\n      globalThis.location.replace(currentUrl.href);\n    } catch (error) {\n      console.error('Error during reload:', error);\n      // Fallback: simple location reload\n      globalThis.location.reload();\n    }\n  }\n\n  /**\n   * Normalizes different error types to Error object\n   */\n  private normalizeError(error: unknown): Error {\n    if (error instanceof Error) {\n      return error;\n    }\n\n    if (typeof error === 'string') {\n      return new Error(error);\n    }\n\n    if (\n      error !== null &&\n      error !== undefined &&\n      typeof error === 'object' &&\n      'message' in error\n    ) {\n      return new Error(String(error.message));\n    }\n\n    return new Error(String(error));\n  }\n\n  /**\n   * Resets the update prompt flag (useful for testing)\n   */\n  resetUpdatePrompt(): void {\n    this.hasShownUpdatePrompt = false;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;AAOM,IAAO,uBAAP,MAAO,sBAAoB;EACd,eAAe,OAAO,YAAY;EAC3C,uBAAuB;;;;EAK/B,uBAAuB,OAAc;AACnC,UAAM,WAAW,KAAK,eAAe,KAAK;AAE1C,UAAM,kBAAkB;MACtB;MACA;MACA;MACA;MACA;MACA;;AAGF,UAAM,UAAU,SAAS,WAAW;AACpC,UAAM,OAAO,SAAS,QAAQ;AAE9B,WAAO,gBAAgB,KACrB,CAAC,YAAY,QAAQ,KAAK,OAAO,KAAK,QAAQ,KAAK,IAAI,CAAC;EAE5D;;;;EAKA,sBAAsB,cAAqB;AACzC,QAAI,KAAK,sBAAsB;AAC7B,cAAQ,KAAK,kCAAkC;AAC/C;IACF;AAEA,SAAK,uBAAuB;AAE5B,UAAM,UAAU,UAAU,YAAY,IAClC,+BAA+B,YAAY,uDAC3C;AAEJ,SAAK,aAAa,YAAY,oBAAoB,SAAS,EAAE,MAAM,IAAI,CAAE;AAGzE,eAAW,MAAK;AACd,WAAK,kBAAiB;IACxB,GAAG,IAAI;EACT;;;;EAKQ,oBAAiB;AACvB,QAAI;AAEF,UAAI,mBAAmB,WAAW;AAChC,kBAAU,cACP,iBAAgB,EAChB,KAAK,CAAC,kBAAiB;AACtB,wBAAc,QAAQ,CAAC,QAAO;AAC5B,gBACG,WAAU,EACV,KAAK,MAAK;AACT,sBAAQ,IAAI,6BAA6B;YAC3C,CAAC,EACA,MAAM,MAAK;YAAE,CAAC;UACnB,CAAC;QACH,CAAC,EACA,MAAM,CAAC,UACN,QAAQ,KAAK,yCAAyC,KAAK,CAAC;MAElE;AAGA,YAAM,aAAa,IAAI,IAAI,WAAW,SAAS,IAAI;AACnD,iBAAW,aAAa,IAAI,MAAM,KAAK,IAAG,EAAG,SAAQ,CAAE;AAGvD,iBAAW,SAAS,QAAQ,WAAW,IAAI;IAC7C,SAAS,OAAO;AACd,cAAQ,MAAM,wBAAwB,KAAK;AAE3C,iBAAW,SAAS,OAAM;IAC5B;EACF;;;;EAKQ,eAAe,OAAc;AACnC,QAAI,iBAAiB,OAAO;AAC1B,aAAO;IACT;AAEA,QAAI,OAAO,UAAU,UAAU;AAC7B,aAAO,IAAI,MAAM,KAAK;IACxB;AAEA,QACE,UAAU,QACV,UAAU,UACV,OAAO,UAAU,YACjB,aAAa,OACb;AACA,aAAO,IAAI,MAAM,OAAO,MAAM,OAAO,CAAC;IACxC;AAEA,WAAO,IAAI,MAAM,OAAO,KAAK,CAAC;EAChC;;;;EAKA,oBAAiB;AACf,SAAK,uBAAuB;EAC9B;;qCApHW,uBAAoB;EAAA;4EAApB,uBAAoB,SAApB,sBAAoB,WAAA,YAFnB,OAAM,CAAA;;;sEAEP,sBAAoB,CAAA;UAHhC;WAAW;MACV,YAAY;KACb;;;",
  "names": []
}
