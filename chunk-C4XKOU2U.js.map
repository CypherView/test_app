{
  "version": 3,
  "sources": ["src/app/features/administration/guards/smart-redirect.guard.ts"],
  "sourcesContent": ["import { CanActivateFn, Router } from '@angular/router';\nimport { inject } from '@angular/core';\nimport { ClientPermissionsService } from '../services/client-permissions.service';\nimport {\n  CLIENT_ADMIN_FEATURES,\n  ClientFeatureId,\n} from '../components/clients/client-administration.config';\nimport { isDefined, isNullOrUndefined } from '../../../shared/utils';\nimport { PermissionService } from '../../../core/services/permission.service';\nimport {\n  FeatureConfig,\n  OwnerType,\n} from '../../../core/models/permission.model';\n\n/**\n * Smart redirect guard that finds the first accessible child based on permissions.\n * Used for parent routes with children to avoid locking users out.\n *\n * @param parentPath - Parent route path segment\n * @param childIds - Array of child feature IDs to check, in order of preference\n * @returns Guard function that navigates to first accessible child or returns false\n */\nexport function createSmartRedirectGuard(\n  parentPath: string,\n  childIds: ClientFeatureId[],\n): CanActivateFn {\n  return (_route, state) => {\n    const clientPermissionsService = inject(ClientPermissionsService);\n    const router = inject(Router);\n\n    // Get the clientId from the current URL\n    const parts = state.url.split('/');\n    const clientIdIndex = parts.indexOf('client');\n    const clientId =\n      clientIdIndex !== -1 && clientIdIndex + 1 < parts.length\n        ? parts[clientIdIndex + 1]\n        : null;\n\n    if (isNullOrUndefined(clientId)) {\n      return false;\n    }\n\n    // Find the first accessible child\n    for (const childId of childIds) {\n      const config = CLIENT_ADMIN_FEATURES[childId];\n      const hasAccess = clientPermissionsService.canAccessFeature(\n        'permissions' in config ? config.permissions : undefined,\n      );\n\n      if (hasAccess) {\n        // Navigate to the first accessible child\n        return router.createUrlTree([\n          'admin',\n          'client',\n          clientId,\n          parentPath,\n          childId,\n        ]);\n      }\n    }\n\n    // If no children are accessible, redirect to unauthorized\n    return router.createUrlTree(['/unauthorized'], {\n      queryParams: { requiredPermission: 'no_access' },\n    });\n  };\n}\n\n/**\n * Smart redirect guard with context-aware permission checks.\n * Used for vendor/distributor admin sections.\n */\nexport function createContextSmartRedirectGuard(\n  entitySegment: 'vendor' | 'distributor' | 'client',\n  parentPath: string,\n  childIds: string[],\n  context: OwnerType,\n  featureConfig: Record<string, FeatureConfig>,\n): CanActivateFn {\n  return (_route, state) => {\n    const permissionService = inject(PermissionService);\n    const router = inject(Router);\n\n    const parts = state.url.split('/');\n    const entityIndex = parts.indexOf(entitySegment);\n    const entityId =\n      entityIndex !== -1 && entityIndex + 1 < parts.length\n        ? parts[entityIndex + 1]\n        : null;\n\n    if (isNullOrUndefined(entityId)) {\n      return false;\n    }\n\n    for (const childId of childIds) {\n      const config = featureConfig[childId];\n      const permissions =\n        isDefined(config) && 'permissions' in config\n          ? config.permissions\n          : undefined;\n      const hasAccess = permissionService.canAccess(permissions, context);\n\n      if (hasAccess) {\n        return router.createUrlTree([\n          'admin',\n          entitySegment,\n          entityId,\n          parentPath,\n          childId,\n        ]);\n      }\n    }\n\n    return router.createUrlTree(['/unauthorized'], {\n      queryParams: { requiredPermission: 'no_access' },\n    });\n  };\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;AAsBM,SAAU,yBACd,YACA,UAA2B;AAE3B,SAAO,CAAC,QAAQ,UAAS;AACvB,UAAM,2BAA2B,OAAO,wBAAwB;AAChE,UAAM,SAAS,OAAO,MAAM;AAG5B,UAAM,QAAQ,MAAM,IAAI,MAAM,GAAG;AACjC,UAAM,gBAAgB,MAAM,QAAQ,QAAQ;AAC5C,UAAM,WACJ,kBAAkB,MAAM,gBAAgB,IAAI,MAAM,SAC9C,MAAM,gBAAgB,CAAC,IACvB;AAEN,QAAI,kBAAkB,QAAQ,GAAG;AAC/B,aAAO;IACT;AAGA,eAAW,WAAW,UAAU;AAC9B,YAAM,SAAS,sBAAsB,OAAO;AAC5C,YAAM,YAAY,yBAAyB,iBACzC,iBAAiB,SAAS,OAAO,cAAc,MAAS;AAG1D,UAAI,WAAW;AAEb,eAAO,OAAO,cAAc;UAC1B;UACA;UACA;UACA;UACA;SACD;MACH;IACF;AAGA,WAAO,OAAO,cAAc,CAAC,eAAe,GAAG;MAC7C,aAAa,EAAE,oBAAoB,YAAW;KAC/C;EACH;AACF;AAMM,SAAU,gCACd,eACA,YACA,UACA,SACA,eAA4C;AAE5C,SAAO,CAAC,QAAQ,UAAS;AACvB,UAAM,oBAAoB,OAAO,iBAAiB;AAClD,UAAM,SAAS,OAAO,MAAM;AAE5B,UAAM,QAAQ,MAAM,IAAI,MAAM,GAAG;AACjC,UAAM,cAAc,MAAM,QAAQ,aAAa;AAC/C,UAAM,WACJ,gBAAgB,MAAM,cAAc,IAAI,MAAM,SAC1C,MAAM,cAAc,CAAC,IACrB;AAEN,QAAI,kBAAkB,QAAQ,GAAG;AAC/B,aAAO;IACT;AAEA,eAAW,WAAW,UAAU;AAC9B,YAAM,SAAS,cAAc,OAAO;AACpC,YAAM,cACJ,UAAU,MAAM,KAAK,iBAAiB,SAClC,OAAO,cACP;AACN,YAAM,YAAY,kBAAkB,UAAU,aAAa,OAAO;AAElE,UAAI,WAAW;AACb,eAAO,OAAO,cAAc;UAC1B;UACA;UACA;UACA;UACA;SACD;MACH;IACF;AAEA,WAAO,OAAO,cAAc,CAAC,eAAe,GAAG;MAC7C,aAAa,EAAE,oBAAoB,YAAW;KAC/C;EACH;AACF;",
  "names": []
}
