{
  "version": 3,
  "sources": ["src/app/layouts/components/flutter-layout/flutter-layout.component.ts", "src/app/layouts/components/flutter-layout/flutter-layout.component.html"],
  "sourcesContent": ["import { Component, OnInit, OnDestroy, NgZone, inject } from '@angular/core';\nimport { environment } from '../../../../environments/environment';\nimport { SafeResourceUrl, DomSanitizer } from '@angular/platform-browser';\nimport { BroadcastMessageService } from '../../../core/services/message.service';\nimport { Subscription, timer } from 'rxjs';\n\n@Component({\n  selector: 'app-flutter-layout',\n  imports: [],\n  templateUrl: './flutter-layout.component.html',\n  styleUrl: './flutter-layout.component.scss',\n})\nexport class FlutterLayoutComponent implements OnInit, OnDestroy {\n  private readonly sanitizer = inject(DomSanitizer);\n  private readonly messageService = inject(BroadcastMessageService);\n  private readonly ngZone = inject(NgZone);\n\n  safeUrl: SafeResourceUrl;\n  private flutterLoaded = false;\n  private readonly subscription = new Subscription();\n  private initializationAttempts = 0;\n  private readonly MAX_INITIALIZATION_ATTEMPTS = 5;\n  private readonly RETRY_DELAY = 2000; // 2 seconds\n\n  constructor() {\n    this.safeUrl = this.sanitizer.bypassSecurityTrustResourceUrl(\n      environment.flutterUrl,\n    );\n  }\n\n  ngOnInit(): void {\n    // Listen for iframe load event\n    window.addEventListener('message', this.handleIframeLoad.bind(this));\n\n    let lastReadyTimestamp = 0;\n\n    this.subscription.add(\n      this.messageService.messages$.subscribe((messages) => {\n        // Check for the most recent \"ready\" message from Flutter\n        const readyMessages = messages.filter(\n          (msg) =>\n            msg.type === 'action' &&\n            msg.action === 'ready' &&\n            msg.sender === 'flutter',\n        );\n\n        if (readyMessages.length > 0) {\n          const latestReady = readyMessages[readyMessages.length - 1];\n          if (\n            latestReady.timestamp &&\n            latestReady.timestamp > lastReadyTimestamp\n          ) {\n            lastReadyTimestamp = latestReady.timestamp;\n            this.flutterLoaded = true;\n            this.initializationAttempts = 0;\n            // Send auth tokens when Flutter is ready\n            this.sendAuthTokensToFlutter();\n          }\n        }\n      }),\n    );\n\n    // Listen for connection status changes\n    this.subscription.add(\n      this.messageService.connectionStatus$.subscribe((status) => {\n        if (status.isConnected) {\n          if (!this.flutterLoaded) {\n            this.flutterLoaded = true;\n            this.initializationAttempts = 0;\n            // Send auth tokens to Flutter upon connection\n            this.ngZone.runOutsideAngular(() => {\n              setTimeout(() => {\n                this.ngZone.run(() => {\n                  this.messageService.sendAuthTokensToFlutter();\n                });\n              }, 500);\n            });\n          }\n        } else {\n          this.flutterLoaded = false;\n        }\n      }),\n    );\n\n    // Set up a safety fallback timer to ensure auth tokens are sent\n    this.setupFallbackTimer();\n  }\n\n  ngOnDestroy(): void {\n    window.removeEventListener('message', this.handleIframeLoad.bind(this));\n    this.subscription.unsubscribe();\n  }\n\n  private handleIframeLoad(event: MessageEvent): void {\n    // If the message is not from our domain, ignore it\n    if (event.data === null || event.data === undefined) return;\n\n    // Handle different message types\n    switch (event.data.type) {\n      case 'flutter-initialized':\n        this.flutterLoaded = true;\n        this.initializationAttempts = 0;\n        // Send auth tokens to Flutter when it's initialized\n        this.sendAuthTokensToFlutter();\n        break;\n\n      case 'flutter-request-tokens':\n        // Send tokens immediately when requested\n        this.sendAuthTokensToFlutter(0);\n        break;\n\n      case 'flutter-keep-alive':\n        // Just log these messages at debug level\n        console.debug('Received keep-alive from Flutter', event.data.timestamp);\n        // If Flutter is sending keep-alives but we haven't marked it as loaded, do so now\n        if (!this.flutterLoaded) {\n          this.flutterLoaded = true;\n          this.initializationAttempts = 0;\n          this.sendAuthTokensToFlutter();\n        }\n        break;\n    }\n  }\n\n  private sendAuthTokensToFlutter(delayMs = 500): void {\n    this.ngZone.runOutsideAngular(() => {\n      setTimeout(() => {\n        this.ngZone.run(() => {\n          this.messageService.sendAuthTokensToFlutter();\n        });\n      }, delayMs);\n    });\n  }\n\n  private setupFallbackTimer(): void {\n    // Set up a repeating timer that attempts to send auth tokens if Flutter hasn't loaded\n    const fallbackTimer = timer(5000, this.RETRY_DELAY).subscribe(() => {\n      if (this.initializationAttempts >= this.MAX_INITIALIZATION_ATTEMPTS) {\n        fallbackTimer.unsubscribe();\n        return;\n      }\n\n      if (!this.flutterLoaded) {\n        this.messageService.sendAuthTokensToFlutter();\n        this.initializationAttempts++;\n      } else {\n        fallbackTimer.unsubscribe();\n      }\n    });\n\n    this.subscription.add(fallbackTimer);\n  }\n}\n", "<iframe\n  id=\"flutter-app\"\n  [src]=\"safeUrl\"\n  class=\"flutter-app-iframe\"\n  title=\"Embedded Flutter Application\"\n  allow=\"same-origin; scripts; fullscreen\"\n  sandbox=\"allow-scripts allow-same-origin allow-forms allow-popups allow-downloads\"\n></iframe>\n"],
  "mappings": "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",
  "names": []
}
